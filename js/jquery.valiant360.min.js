var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var t=document.createElement("canvas");return!!window.WebGLRenderingContext&&(t.getContext("webgl")||t.getContext("experimental-webgl"))}catch(t){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var t=document.createElement("div");return t.id="webgl-error-message",t.style.fontFamily="monospace",t.style.fontSize="13px",t.style.fontWeight="normal",t.style.textAlign="center",t.style.background="#fff",t.style.color="#000",t.style.padding="1.5em",t.style.width="400px",t.style.margin="5em auto 0",this.webgl||(t.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),t},addGetWebGLMessage:function(t){var e,i,s;e=void 0!==(t=t||{}).parent?t.parent:document.body,i=void 0!==t.id?t.id:"oldie",(s=Detector.getWebGLErrorMessage()).id=i,e.appendChild(s)}};!function(t,e,i,s,o,n){function a(e,i){this.element=e,this.options=t.extend({},l,i),this._defaults=l,this._name=r,this.init()}var r="Valiant360",l={crossOrigin:"anonymous",clickAndDrag:!1,keyboardControls:!0,fov:35,fovMin:3,fovMax:100,hideControls:!1,lon:0,lat:0,loop:"loop",muted:!0,volume:.5,debug:!1,flatProjection:!1,autoplay:!0};a.prototype={init:function(){this._time=(new Date).getTime(),this._controls={},this._id=this.generateUUID(),this._requestAnimationId="",this._isVideo=!1,this._isPhoto=!1,this._isFullscreen=!1,this._mouseDown=!1,this._dragStart={},this._lat=this.options.lat,this._lon=this.options.lon,this._fov=this.options.fov,this._originalWidth=t(this.element).find("canvas").width(),this._originalHeight=t(this.element).find("canvas").height(),t(this.element).addClass("Valiant360_default"),this.options.keyboardControls&&!t(this.element).attr("tabindex")&&t(this.element).attr("tabindex","1"),this.createMediaPlayer(),this.createControls()},generateUUID:function(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:7&i|8).toString(16)})},createMediaPlayer:function(){var n=this;this._scene=new e.Scene,this._camera=new e.PerspectiveCamera(this._fov,t(this.element).width()/t(this.element).height(),.1,1e3),this._camera.setLens(this._fov),this._renderer=i.webgl?new e.WebGLRenderer:new e.CanvasRenderer,this._renderer.setSize(t(this.element).width(),t(this.element).height()),this._renderer.autoClear=!1,this._renderer.setClearColor(3355443,1),t(this.element).append(this._renderer.domElement);var a=function(){n._texture.generateMipmaps=!1,n._texture.minFilter=e.LinearFilter,n._texture.magFilter=e.LinearFilter,n._texture.format=e.RGBFormat,n._mesh=new e.Mesh(new e.SphereGeometry(500,80,50),new e.MeshBasicMaterial({map:n._texture})),n._mesh.scale.x=-1,n._scene.add(n._mesh),n.animate()};if(t(this.element).attr("data-photo-src"))this._isPhoto=!0,e.ImageUtils.crossOrigin=this.options.crossOrigin,this._texture=e.ImageUtils.loadTexture(t(this.element).attr("data-photo-src")),a();else{this._isVideo=!0;t(this.element).append('<div class="loading"> \t\t\t\t\t\t\t\t\t\t<div class="icon waiting-icon"></div> \t\t\t\t\t\t\t\t\t\t<div class="icon error-icon"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i></div> \t\t\t\t\t\t\t\t\t</div>'),this.showWaiting(),this._video=o.createElement("video"),this._video.setAttribute("crossorigin",this.options.crossOrigin),this._video.style.display="none",t(this.element).append(this._video),this._video.loop=this.options.loop,this._video.muted=this.options.muted,this._video.volume=this.options.volume,this._video.addEventListener("ended",function(){}),this._video.addEventListener("progress",function(){var t=null;n._video&&n._video.buffered&&n._video.buffered.length>0&&n._video.buffered.end&&n._video.duration?t=n._video.buffered.end(0)/n._video.duration:n._video&&void 0!==n._video.bytesTotal&&n._video.bytesTotal>0&&void 0!==n._video.bufferedBytes&&(t=n._video.bufferedBytes/n._video.bytesTotal);Math.round(100*t)}),this._video.addEventListener("error",function(t){console.error(n._video.error),n.showError()}),this._video.addEventListener("timeupdate",function(e){if(!1===this.paused&&!n.options.hideControls){var i=100*this.currentTime/this.duration;t(n.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[0].setAttribute("style","width:"+i+"%;"),t(n.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[1].setAttribute("style","width:"+(100-i)+"%;");var s=Math.floor(this.duration/60),o=Math.floor(this.duration-60*s),a=Math.floor(this.currentTime/60),r=Math.floor(this.currentTime-60*a),l=s+":"+(o<10?"0"+o:o),h=a+":"+(r<10?"0"+r:r);t(n.element).find(".controls .timeLabel").html(h+" / "+l)}});var r="Microsoft Internet Explorer"==navigator.appName||!(!navigator.userAgent.match(/Trident/)&&!navigator.userAgent.match(/rv 11/));r?(this._videocanvas=o.createElement("canvas"),this._texture=new e.Texture(this._videocanvas),this._video.addEventListener("loadedmetadata",function(){n._videocanvas.width=n._video.videoWidth,n._videocanvas.height=n._video.videoHeight,a()})):this._texture=new e.Texture(this._video);var l=new XMLHttpRequest;l.open("GET",t(this.element).attr("data-video-src"),!0),l.responseType="blob",l.onload=function(e){if(200===this.status){var i=(s.webkitURL?webkitURL:URL).createObjectURL(this.response);t(n._video).bind("canplaythrough",function(){!0===n.options.autoplay&&(n.hideWaiting(),n.play(),n._videoReady=!0)}),n._video.src=i}},l.onreadystatechange=function(t){4===l.readyState&&200!==l.status&&(console.error("Video error: status "+l.status),n.showError())},l.send(),r||a()}},createControls:function(){var e=this.options.muted?"fa-volume-off":"fa-volume-up",i=this.options.autoplay?"fa-pause":"fa-play";if(t(this.element).attr("data-photo-src")&&(this.options.hideControls=!0,this.options.keyboardControls=!1),this.options.hideControls)s=' \t\t\t\t  <div class="controlsWrapper">\t\t\t\t\t<div class="controls"> \t\t\t\t\t\t<a href="#" class="playButton button fa '+i+'"></a> \t\t\t\t\t\t<div class="audioControl">\t\t\t\t\t\t\t<a href="#" class="muteButton button fa '+e+'"></a> \t\t\t\t\t\t\t<div class="volumeControl">\t\t\t\t\t\t\t\t<div class="volumeBar">\t\t\t\t\t\t\t\t\t<div class="volumeProgress"></div>\t\t\t\t\t\t\t\t\t<div class="volumeCursor"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t\t<span class="timeLabel"></span> \t\t\t\t\t\t<a href="#" class="fullscreenButton button fa fa-expand"></a> \t\t\t\t\t</div> \t\t\t\t  </div>\t\t\t\t';else var s=' \t\t\t\t  <div class="controlsWrapper">\t\t\t\t\t<div class="valiant-progress-bar">\t\t\t\t\t\t<div style="width: 0;"></div><div style="width: 100%;"></div>\t\t\t\t\t</div>\t\t\t\t\t<div class="controls"> \t\t\t\t\t\t<a href="#" class="playButton button fa '+i+'"></a> \t\t\t\t\t\t<div class="audioControl">\t\t\t\t\t\t\t<a href="#" class="muteButton button fa '+e+'"></a> \t\t\t\t\t\t\t<div class="volumeControl">\t\t\t\t\t\t\t\t<div class="volumeBar">\t\t\t\t\t\t\t\t\t<div class="volumeProgress"></div>\t\t\t\t\t\t\t\t\t<div class="volumeCursor"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t\t<span class="timeLabel"></span> \t\t\t\t\t\t<a href="#" class="fullscreenButton button fa fa-expand"></a> \t\t\t\t\t</div> \t\t\t\t  </div>\t\t\t\t';t(this.element).append(s,!0),t(this.element).append('<div class="timeTooltip">00:00</div>',!0),this.options.hideControls&&t(this.element).find(".controls").hide(),this.attachControlEvents()},attachControlEvents:function(){var e=this;this.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.element.addEventListener("touchmove",this.onMouseMove.bind(this),!1),this.element.addEventListener("mousewheel",this.onMouseWheel.bind(this),!1),this.element.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!1),this.element.addEventListener("mousedown",this.onMouseDown.bind(this),!1),this.element.addEventListener("touchstart",this.onMouseDown.bind(this),!1),this.element.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this.element.addEventListener("touchend",this.onMouseUp.bind(this),!1),this.options.keyboardControls&&(this.element.addEventListener("keydown",this.onKeyDown.bind(this),!1),this.element.addEventListener("keyup",this.onKeyUp.bind(this),!1),this.element.addEventListener("keyArrowPress",this.onKeyArrowPress.bind(this),!1),this.element.addEventListener("click",function(){t(e.element).focus()},!1)),this.options.hideControls||(t(e.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("click",this.onProgressClick.bind(this),!1),t(e.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("mousemove",this.onProgressMouseMove.bind(this),!1),t(e.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("mouseout",this.onProgressMouseOut.bind(this),!1)),t(o).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",this.fullscreen.bind(this)),t(s).resize(function(){e.resizeGL(t(e.element).width(),t(e.element).height())}),t(this.element).find(".playButton").click(function(i){i.preventDefault(),t(this).hasClass("fa-pause")?(t(this).removeClass("fa-pause").addClass("fa-play"),e.pause()):(t(this).removeClass("fa-play").addClass("fa-pause"),e.play())}),t(this.element).find(".fullscreenButton").click(function(i){i.preventDefault();var s=t(e.element)[0];t(this).hasClass("fa-expand")?s.requestFullscreen?s.requestFullscreen():s.msRequestFullscreen?s.msRequestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen():s.requestFullscreen?o.exitFullscreen():s.msRequestFullscreen?o.msExitFullscreen():s.mozRequestFullScreen?o.mozCancelFullScreen():s.webkitRequestFullscreen&&o.webkitExitFullscreen()}),t(this.element).find(".muteButton").click(function(i){i.preventDefault(),t(this).hasClass("fa-volume-off")?(t(this).removeClass("fa-volume-off").addClass("fa-volume-up"),e._video.muted=!1):(t(this).removeClass("fa-volume-up").addClass("fa-volume-off"),e._video.muted=!0)}),t(this.element).find(".controlsWrapper .volumeControl").mousedown(this.onVolumeMouseDown.bind(this)).mouseup(this.onVolumeMouseUp.bind(this)).mouseleave(this.onVolumeMouseUp.bind(this)).mousemove(this.onVolumeMouseMove.bind(this)),t(this._video).on("volumechange",this.onVolumeChange.bind(this))},onMouseMove:function(e){this._onPointerDownPointerX=e.clientX,this._onPointerDownPointerY=-e.clientY,this.relativeX=e.pageX-t(this.element).find("canvas").offset().left,this._onPointerDownLon=this._lon,this._onPointerDownLat=this._lat;var i,s;this.options.clickAndDrag?this._mouseDown&&(i=e.pageX-this._dragStart.x,s=e.pageY-this._dragStart.y,this._dragStart.x=e.pageX,this._dragStart.y=e.pageY,this._lon+=i,this._lat-=s):(i=e.pageX-t(this.element).find("canvas").offset().left,s=e.pageY-t(this.element).find("canvas").offset().top,this._lon=i/t(this.element).find("canvas").width()*430-225,this._lat=s/t(this.element).find("canvas").height()*-180+90)},onMouseWheel:function(t){t.wheelDeltaY?this._fov-=-.01*t.wheelDeltaY:t.wheelDelta?this._fov-=-.01*t.wheelDelta:t.detail&&(this._fov+=1*t.detail),this._fov<this.options.fovMin?this._fov=this.options.fovMin:this._fov>this.options.fovMax&&(this._fov=this.options.fovMax),this._camera.setLens(this._fov),t.preventDefault()},onMouseDown:function(t){this._mouseDown=!0,this._dragStart.x=t.pageX,this._dragStart.y=t.pageY},onProgressClick:function(e){if(this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA){var i=this.relativeX/t(this.element).find("canvas").width()*100;this.options.hideControls||(t(this.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[0].setAttribute("style","width:"+i+"%;"),t(this.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[1].setAttribute("style","width:"+(100-i)+"%;")),this._video.currentTime=this._video.duration*i/100}},onProgressMouseMove:function(e){var i=this.relativeX/t(this.element).find("canvas").width()*100;if(i){var s=t(this.element).find(".timeTooltip"),o=this.relativeX-s.width()/2;o=o<0?0:Math.min(o,t(this.element).find("canvas").width()-s.outerWidth()),s.css({left:o+"px"}),s.show();var n=i/100*this._video.duration,a=Math.floor(n/60),r=Math.floor(n-60*a);s.html(a+":"+(r<10?"0"+r:r))}},onProgressMouseOut:function(e){t(this.element).find(".timeTooltip").hide()},onMouseUp:function(t){this._mouseDown=!1},onKeyDown:function(t){var e=t.keyCode;if(e>=37&&e<=40){t.preventDefault(),this._keydown=!0;var i=o.createEvent("CustomEvent");i.initCustomEvent("keyArrowPress",!0,!0,{keyCode:e}),this.element.dispatchEvent(i)}},onKeyUp:function(t){var e=t.keyCode;e>=37&&e<=40&&(t.preventDefault(),this._keydown=!1)},onKeyArrowPress:function(t){if(this._keydown){var e=t.detail?t.detail.keyCode:null,i=this.element;switch(t.preventDefault(),e){case 37:this._lon-=3;break;case 39:this._lon+=3;break;case 38:this._lat+=3;break;case 40:this._lat-=3}setTimeout(function(){var t=o.createEvent("CustomEvent");t.initCustomEvent("keyArrowPress",!0,!0,{keyCode:e}),i.dispatchEvent(t)},50)}},onVolumeMouseDown:function(t){t.preventDefault(),this._volumeMouseDown=!0,this.onVolumeMouseMove(t)},onVolumeMouseUp:function(t){t.preventDefault(),this._volumeMouseDown=!1},onVolumeMouseMove:function(e){if(e.preventDefault(),this._volumeMouseDown){var i=t(this.element).find(".controlsWrapper .volumeControl"),s=(this.relativeX-i.offset().left+i.find(".volumeBar > .volumeCursor").width()/2)/i.width()*100;s>=0&&s<=100&&(this._video.volume=s/100)}},onVolumeChange:function(e){var i=1!=this._video.muted||this._volumeMouseDown?100*this._video.volume:0;t(this.element).find(".controlsWrapper .volumeControl > .volumeBar").css({width:i+"%"});var s=t(this.element).find(".muteButton");(i>0&&s.hasClass("fa-volume-off")||0==i&&s.hasClass("fa-volume-up"))&&s.click()},animate:function(){if(this._requestAnimationId=requestAnimationFrame(this.animate.bind(this)),this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA&&(this._videocanvas&&this._videocanvas.getContext("2d").drawImage(this._video,0,0,this._videocanvas.width,this._videocanvas.height),void 0!==this._texture)){var t=(new Date).getTime();t-this._time>=30&&(this._texture.needsUpdate=!0,this._time=t)}this.render()},render:function(){this._lat=Math.max(-85,Math.min(85,this._lat)),this._phi=(90-this._lat)*Math.PI/180,this._theta=this._lon*Math.PI/180;var t=500*Math.sin(this._phi)*Math.cos(this._theta),i=500*Math.cos(this._phi),s=500*Math.sin(this._phi)*Math.sin(this._theta);this._camera.lookAt(new e.Vector3(t,i,s)),this.options.flatProjection?(this._camera.position.x=0,this._camera.position.y=0,this._camera.position.z=0):(this._camera.position.x=-t,this._camera.position.y=-i,this._camera.position.z=-s),this._renderer.clear(),this._renderer.render(this._scene,this._camera)},play:function(){this._video.play()},pause:function(){this._video.pause()},loadVideo:function(t){this._video.src=t},unloadVideo:function(){this.pause(),this._video.src="",this._video.removeAttribute("src")},loadPhoto:function(t){this._texture=e.ImageUtils.loadTexture(t)},fullscreen:function(){t(this.element).find("a.fa-expand").length>0?(this.resizeGL(screen.width,screen.height),t(this.element).addClass("fullscreen"),t(this.element).find("a.fa-expand").removeClass("fa-expand").addClass("fa-compress"),this._isFullscreen=!0):(this.resizeGL(this._originalWidth,this._originalHeight),t(this.element).removeClass("fullscreen"),t(this.element).find("a.fa-compress").removeClass("fa-compress").addClass("fa-expand"),this._isFullscreen=!1)},resizeGL:function(t,e){this._renderer.setSize(t,e),this._camera.aspect=t/e,this._camera.updateProjectionMatrix()},showWaiting:function(){var e=t(this.element).find(".loading");e.find(".waiting-icon").show(),e.find(".error-icon").hide(),e.show()},hideWaiting:function(){t(this.element).find(".loading").hide()},showError:function(){var e=t(this.element).find(".loading");e.find(".waiting-icon").hide(),e.find(".error-icon").show(),e.show()},destroy:function(){s.cancelAnimationFrame(this._requestAnimationId),this._requestAnimationId="",this._texture.dispose(),this._scene.remove(this._mesh),this._isVideo&&this.unloadVideo(),t(this._renderer.domElement).remove()}},t.fn[r]=function(e){var i=arguments;return this.each(function(){if("object"!=typeof e&&e){if(this.plugin[e])return this.plugin[e].apply(this.plugin,Array.prototype.slice.call(i,1))}else this.plugin=new a(this,e),t.data(this,"plugin_"+r)||t.data(this,"plugin_"+r,this.plugin)})}}(jQuery,THREE,Detector,window,document);